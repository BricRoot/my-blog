<p>这个月开始放暑假了，闲的没事开始搞起了异地组网，这次记录一下我怎么配置的WireGuard</p><h3 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h3><p>首先我们要有一台公网IP的服务器，这个服务器哪里都可以买到，只要宽带高就行，宽带低的话速度太慢了<br>系统我选择的是Debian，使用Ubuntu的话安装WireGuard的方式是一样的</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 安装WireGuard和iptables</span><br><span class="hljs-attribute">apt</span> update &amp;&amp; apt install wireguard iptables -y<br><span class="hljs-comment"># 配置IP转发</span><br><span class="hljs-attribute">sysctl</span> -w net.ipv4.ip_forward=<span class="hljs-number">1</span><br><span class="hljs-attribute">echo</span> &#x27;net.ipv4.ip_forward=<span class="hljs-number">1</span>&#x27; | sudo tee -a /etc/sysctl.conf<br><span class="hljs-comment"># 配置NAT规则(如果不懂下面每个配置的含义请保持默认)</span><br><span class="hljs-attribute">iptables</span> -t nat -A POSTROUTING -s <span class="hljs-number">10.0.0.0</span>/<span class="hljs-number">24</span> -o eth0 -j MASQUERADE<br><span class="hljs-attribute">iptables</span> -A FORWARD -i wg0 -o eth0 -j ACCEPT<br><span class="hljs-attribute">iptables</span> -A FORWARD -o wg0 -i eth0 -j ACCEPT<br></code></pre></td></tr></table></figure><p>等待跑完代码即可<br>接下来就是生成密钥，这个密钥就是我们本地设备与服务器互相连通的密码，这串密码非常的复杂，我们用下面的命令生成<br>我的设备有Debian(服务端)，OpenWrt(客户端)，安卓手机(客户端)，笔记本(客户端)，所以我需要生成四串密钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 新建一个文件夹，这个文件夹存放密钥和配置文件</span><br><span class="hljs-built_in">mkdir</span> -p /etc/wireguard<br><span class="hljs-comment"># 生成Debian(服务端)的密钥</span><br>wg genkey | <span class="hljs-built_in">tee</span> server_private.key | wg pubkey | <span class="hljs-built_in">tee</span> server_public.key<br><span class="hljs-comment"># 生成Openwrt(客户端)的密钥</span><br>wg genkey | <span class="hljs-built_in">tee</span> openwrt_private.key | wg pubkey | <span class="hljs-built_in">tee</span> openwrt_public.key<br><span class="hljs-comment"># 生成安卓手机(客户端)的密钥</span><br>wg genkey | <span class="hljs-built_in">tee</span> android_private.key | wg pubkey | <span class="hljs-built_in">tee</span> android_public.key<br><span class="hljs-comment"># 生成笔记本(客户端)的密钥</span><br>wg genkey | <span class="hljs-built_in">tee</span> computer_private.key | wg pubkey | <span class="hljs-built_in">tee</span> computer_public.key<br></code></pre></td></tr></table></figure><p>接下来密钥就生成好了，然后来处理WireGuard的配置文件，配置文件位于&#x2F;etc&#x2F;wireguard&#x2F;wg0.conf请自行新建，下面的配置可以直接抄作业，请自行修改配置</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Interface]</span><br><span class="hljs-attr">PrivateKey</span> = 云服务器的私钥(server_private.key)<br><span class="hljs-attr">Address</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>/<span class="hljs-number">24</span><br><span class="hljs-attr">ListenPort</span> = <span class="hljs-number">51820</span><br><br><span class="hljs-section">[Peer]</span><br><span class="hljs-attr">PublicKey</span> = OpenWrt的公钥(openwrt_public.key)<br><span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">192.168</span>.<span class="hljs-number">2.0</span>/<span class="hljs-number">24</span>, <span class="hljs-number">10.0</span>.<span class="hljs-number">0.2</span>/<span class="hljs-number">32</span> <br><span class="hljs-comment"># 192.168.2.0为本地局域网IP段，请按实际修改</span><br><span class="hljs-attr">PersistentKeepalive</span> = <span class="hljs-number">25</span><br><br><span class="hljs-section">[Peer]</span><br><span class="hljs-attr">PublicKey</span> = 安卓手机的公钥(android_public.key)<br><span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">0.3</span>/<span class="hljs-number">32</span><br><br><span class="hljs-section">[Peer]</span><br><span class="hljs-attr">PublicKey</span> = 笔记本的公钥(computer_public.key)<br><span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">0.4</span>/<span class="hljs-number">32</span><br></code></pre></td></tr></table></figure><p>配置好文件后我们使用下面的命令启动WireGuard服务并添加开机自启动，@符号后面为配置文件名称，根据我的教程走的话保持默认即可</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">systemctl</span> start wg-quick<span class="hljs-variable">@wg0</span><br>systemctl enable wg-quick<span class="hljs-variable">@wg0</span><br></code></pre></td></tr></table></figure><h3 id="OpenWrt配置"><a href="#OpenWrt配置" class="headerlink" title="OpenWrt配置"></a>OpenWrt配置</h3><p>首先安装WireGuard</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmake">opkg update<br>opkg <span class="hljs-keyword">install</span> wireguard-tools kmod-wireguard<br></code></pre></td></tr></table></figure><p>接着编辑OpenWrt的网络配置文件，网络配置文件位于&#x2F;etc&#x2F;config&#x2F;network，也是直接抄作业，记得修改配置</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">config <span class="hljs-keyword">interface</span> <span class="hljs-comment">&#x27;wg0&#x27;</span><br>    <span class="hljs-keyword">option</span> proto <span class="hljs-comment">&#x27;wireguard&#x27;</span><br>    <span class="hljs-keyword">option</span> private_key <span class="hljs-comment">&#x27;OpenWrt的私钥(openwrt_private.key)&#x27;</span><br>    list addresses <span class="hljs-comment">&#x27;10.0.0.2/24&#x27;</span><br><br>config wireguard_wg0<br>    <span class="hljs-keyword">option</span> public_key <span class="hljs-comment">&#x27;云服务器的公钥(server_public.key)&#x27;</span><br>    <span class="hljs-keyword">option</span> endpoint_host <span class="hljs-comment">&#x27;云服务器的公网IP&#x27;</span><br>    <span class="hljs-keyword">option</span> endpoint_port <span class="hljs-comment">&#x27;51820&#x27;</span><br>    <span class="hljs-keyword">option</span> persistent_keepalive <span class="hljs-comment">&#x27;25&#x27;</span><br>    list allowed_ips <span class="hljs-comment">&#x27;0.0.0.0/0&#x27;</span><br></code></pre></td></tr></table></figure><p>接着配置防火墙，不然网络出不去，防火墙的配置文件位于&#x2F;etc&#x2F;config&#x2F;firewall，下面的内容直接复制粘贴即可，什么都不用改，前提是跟着我教程走的</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">config <span class="hljs-keyword">rule</span><br>    <span class="hljs-keyword">option</span> <span class="hljs-type">name</span> <span class="hljs-string">&#x27;Allow-WireGuard-Inbound&#x27;</span><br>    <span class="hljs-keyword">option</span> src <span class="hljs-string">&#x27;wan&#x27;</span><br>    <span class="hljs-keyword">option</span> dest_port <span class="hljs-string">&#x27;51820&#x27;</span><br>    <span class="hljs-keyword">option</span> proto <span class="hljs-string">&#x27;udp&#x27;</span><br>    <span class="hljs-keyword">option</span> target <span class="hljs-string">&#x27;ACCEPT&#x27;</span><br><br>config <span class="hljs-type">zone</span><br>    <span class="hljs-keyword">option</span> <span class="hljs-type">name</span> <span class="hljs-string">&#x27;wg&#x27;</span><br>    <span class="hljs-keyword">option</span> network <span class="hljs-string">&#x27;wg0&#x27;</span><br>    <span class="hljs-keyword">option</span> <span class="hljs-keyword">input</span> <span class="hljs-string">&#x27;ACCEPT&#x27;</span><br>    <span class="hljs-keyword">option</span> output <span class="hljs-string">&#x27;ACCEPT&#x27;</span><br>    <span class="hljs-keyword">option</span> forward <span class="hljs-string">&#x27;ACCEPT&#x27;</span><br>    <span class="hljs-keyword">option</span> masq <span class="hljs-string">&#x27;1&#x27;</span><br>    <span class="hljs-keyword">option</span> mtu_fix <span class="hljs-string">&#x27;1&#x27;</span><br><br>config forwarding<br>    <span class="hljs-keyword">option</span> src <span class="hljs-string">&#x27;wg&#x27;</span><br>    <span class="hljs-keyword">option</span> dest <span class="hljs-string">&#x27;lan&#x27;</span><br><br>config forwarding<br>    <span class="hljs-keyword">option</span> src <span class="hljs-string">&#x27;lan&#x27;</span><br>    <span class="hljs-keyword">option</span> dest <span class="hljs-string">&#x27;wg&#x27;</span><br></code></pre></td></tr></table></figure><p>前面的文件配置好后就可以重启网络和防火墙然后查看连接了</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-regexp">/etc/</span><span class="hljs-keyword">init</span>.d<span class="hljs-operator">/</span>network restart<br><span class="hljs-regexp">/etc/</span><span class="hljs-keyword">init</span>.d<span class="hljs-operator">/</span>firewall restart<br></code></pre></td></tr></table></figure><p>重启好网络和防火墙后，可以使用<code>wg</code>命令来查看连接情况<br><img src="/img/%E4%BD%BF%E7%94%A8WireGuard%E8%AE%BF%E9%97%AEOpenWrt%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B8%8B%E7%9A%84%E5%B1%80%E5%9F%9F%E7%BD%91%E8%AE%BE%E5%A4%87/1.png"></p><h3 id="安卓手机配置"><a href="#安卓手机配置" class="headerlink" title="安卓手机配置"></a>安卓手机配置</h3><p>安卓手机的话可以下载官方的软件，在下面的网站找到安卓设备类型即可<br>链接：<img src="https://www.wireguard.com/install/" alt="WireGuard官方下载网站"><br>下载好后安装打开，请按下面的格式填写，未提及的请保持默认</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs makefile">本地（Interface）<br><span class="hljs-section">名称: 随便填写都可以</span><br><span class="hljs-section">私钥: 安卓手机的私钥(android_private.key)</span><br><span class="hljs-section">公钥: 自动生成即可</span><br><span class="hljs-section">局域网IP: 10.0.0.4/24</span><br>！！！添加节点！！！<br>远程（Peer）<br><span class="hljs-section">公钥: 云服务器的公钥(server_public.key)</span><br><span class="hljs-section">连接保持间隔: 25</span><br><span class="hljs-section">对端: 云服务器的IP:51820</span><br><span class="hljs-section">路由的IP地址（段）: 192.168.2.0/24, 10.0.0.0/24</span><br></code></pre></td></tr></table></figure><p>保存然后启用就可以连接上了<br><img src="/img/%E4%BD%BF%E7%94%A8WireGuard%E8%AE%BF%E9%97%AEOpenWrt%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B8%8B%E7%9A%84%E5%B1%80%E5%9F%9F%E7%BD%91%E8%AE%BE%E5%A4%87/2.jpg"></p><h3 id="笔记本配置"><a href="#笔记本配置" class="headerlink" title="笔记本配置"></a>笔记本配置</h3><p>我的笔记本是Windows系统，还是刚才的链接，下载Windows设备类型的安装文件即可<br>链接：<img src="https://www.wireguard.com/install/" alt="WireGuard官方下载网站"><br>安装好后打开WireGuard，选择左下角的新建隧道<br><img src="/img/%E4%BD%BF%E7%94%A8WireGuard%E8%AE%BF%E9%97%AEOpenWrt%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B8%8B%E7%9A%84%E5%B1%80%E5%9F%9F%E7%BD%91%E8%AE%BE%E5%A4%87/3.png"><br>然后把下面的配置文件粘贴进去即可，记得修改里面的一些配置</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Interface]</span><br><span class="hljs-attr">PrivateKey</span> = 笔记本的私钥(computer_private.key)<br><span class="hljs-attr">Address</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">0.3</span>/<span class="hljs-number">24</span><br><br><span class="hljs-section">[Peer]</span><br><span class="hljs-attr">PublicKey</span> = 云服务器的公钥(server_public.key)<br><span class="hljs-attr">Endpoint</span> = 云服务器的IP:<span class="hljs-number">51820</span><br><span class="hljs-attr">AllowedIPs</span> = <span class="hljs-number">192.168</span>.<span class="hljs-number">2.0</span>/<span class="hljs-number">24</span>, <span class="hljs-number">10.0</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">24</span><br><span class="hljs-attr">PersistentKeepalive</span> = <span class="hljs-number">25</span><br></code></pre></td></tr></table></figure><p>保存后点击连接就大功告成了，这样子就组成一个虚拟的局域网，访问的IP也是跟内网一样不需要改变，流量走的是云服务器的就不用怕没有公网IP</p>